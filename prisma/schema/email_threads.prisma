enum EmailThreadStatus {
    pending
    processing
    scheduled
    awaiting_confirmation
    confirmed
    failed
}

enum EmailThreadIntent {
    schedule
    reschedule
    cancel
    confirm
    info_request
}

model EmailThread {
    id            String             @id @default(uuid())
    userId        String
    user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
    threadId      String             @unique // Gmail thread ID (unique identifier)
    subject       String?
    participants  String[] // Array of email addresses
    status        EmailThreadStatus  @default(pending)
    intent        EmailThreadIntent?
    proposedSlots Json? // Array of proposed time slots: [{start, end, score, reason}, ...]
    workflowRunId String? // For future workflow integration
    createdAt     DateTime           @default(now())
    updatedAt     DateTime           @updatedAt
    meetings      Meeting[]
    messages      EmailMessage[] // All messages in this thread

    @@index([userId])
    @@index([status])
    @@index([threadId])
    @@map("email_threads")
}

model EmailMessage {
    id            String      @id @default(uuid())
    emailThreadId String
    emailThread   EmailThread @relation(fields: [emailThreadId], references: [id], onDelete: Cascade)

    gmailMessageId String   @unique // Gmail message ID
    from           String // Sender email address
    to             String[] // Recipient email addresses
    cc             String[] // CC email addresses
    subject        String?
    body           String // Back-compat: best available body (HTML preferred, else text)
    bodyText       String? // Extracted text/plain (or derived) for stable rendering
    bodyHtml       String? // Extracted text/html when available
    snippet        String? // Gmail snippet
    sentAt         DateTime // When the email was sent

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([emailThreadId])
    @@index([gmailMessageId])
    @@index([sentAt])
    @@map("email_messages")
}

enum MeetingStatus {
    proposed
    confirmed
    cancelled
}

enum MeetingSource {
    email_thread
    chat_assistant
}

model Meeting {
    id            String       @id @default(uuid())
    emailThreadId String?
    emailThread   EmailThread? @relation(fields: [emailThreadId], references: [id])

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    title        String
    description  String?
    participants String[] // Array of email addresses
    startTime    DateTime
    endTime      DateTime
    timezone     String

    calendarEventId String? // ID of the event in the calendar system
    meetingLink     String? // Video conference link (Google Meet, Zoom, etc.)
    status          MeetingStatus @default(proposed)
    source          MeetingSource @default(email_thread)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([emailThreadId])
    @@index([userId])
    @@map("meetings")
}
